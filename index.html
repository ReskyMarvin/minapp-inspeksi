<!doctype html>
<html lang="id">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Form Inspeksi</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <style>
    :root { --gap: 12px; --radius: 14px; }
    * { box-sizing: border-box; }
    body {
      margin: 0; font-family: Inter, system-ui, Arial, sans-serif;
      padding: min(4vw,22px); background: #f5f7fb;
    }
    .card {
      max-width: 780px; margin: 0 auto; background: #fff;
      border-radius: var(--radius); padding: clamp(12px,2.5vw,24px);
      box-shadow: 0 8px 22px rgba(15,23,42,.06);
    }
    h1 { margin: 0 0 6px; font-size: clamp(18px,4.2vw,24px); }
    p.desc { margin: 0 0 16px; color: #51607a; }
    form { display: grid; gap: var(--gap); }
    .grid { display: grid; gap: var(--gap); grid-template-columns: 1fr; }
    @media (min-width: 760px) { .grid { grid-template-columns: repeat(2, 1fr); } }
    label { display: block; font-size: 14px; margin-bottom: 6px; color: #1f2a44; }
    .required::after { content: " *"; color: #b91c1c; }
    input {
      width: 100%; border: 1px solid #e6e9f3; border-radius: 12px;
      padding: 12px 14px; font-size: 14px; background: #fbfcff; outline: none;
      transition: border .15s ease, background .15s ease, transform .04s ease;
    }
    input:focus { border-color: #b9c3f6; background: #fff; }
    .row { display: grid; gap: 6px; }
    .actions { display: flex; gap: var(--gap); flex-wrap: wrap; margin-top: 6px; }
    button {
      border: 0; border-radius: 12px; padding: 12px 16px; font-weight: 600; cursor: pointer; font-size: 14px;
    }
    .btn-primary { background: #3e6ae1; color: #fff; }
    .btn-ghost { background: #eef2ff; color: #334155; }
    .status { margin-top: 10px; font-size: 14px; min-height: 18px; }
    .ok { color: #0a7a43; }
    .err { color: #bb2525; }
  </style>
</head>
<body>
  <div class="card">
    <h1>Inspeksi Kontainer</h1>
    <p class="desc">Ketik pakai HURUF BESAR. Sistem memvalidasi <b>Container No</b> (4 huruf + 7 angka).</p>

    <form id="f">
      <div class="grid">
        <div class="row">
          <label class="required">Container</label>
          <input id="Container" placeholder="C1 / C2 / ..." required />
        </div>
        <div class="row">
          <label class="required">Date</label>
          <input id="Date" placeholder="2025-09-11" required />
        </div>

        <div class="row">
          <label>Shipment Code</label>
          <input id="Shipment Code" placeholder="SHIP-XXXX" />
        </div>
        <div class="row">
          <label>DPF No</label>
          <input id="DPF No" placeholder="DPF-XXXX" />
        </div>

        <div class="row">
          <label>Consignee</label>
          <input id="Consignee" placeholder="PT ABC" />
        </div>
        <div class="row">
          <label>Pickup</label>
          <input id="Pickup" placeholder="WH MINUT" />
        </div>

        <div class="row">
          <label>Transporter</label>
          <input id="Transporter" placeholder="JNE / SAP / ..." />
        </div>
        <div class="row">
          <label class="required">Container No</label>
          <input id="Container No" placeholder="ABCD1234567" required />
        </div>

        <div class="row">
          <label>Seal No</label>
          <input id="Seal No" placeholder="SEAL-XXXX" />
        </div>
        <div class="row">
          <label>Plate No</label>
          <input id="Plate No" placeholder="DB 1234 XX" />
        </div>

        <div class="row">
          <label class="required">Driver</label>
          <input id="Driver" placeholder="NAMA SOPIR" required />
        </div>
        <div class="row">
          <label>Loader</label>
          <input id="Loader" placeholder="NAMA LOADER" />
        </div>
      </div>

      <div class="actions">
        <button type="button" class="btn-ghost" id="btnReset">Reset</button>
        <button type="submit" class="btn-primary" id="btnSubmit">Kirim</button>
      </div>
      <div class="status" id="status"></div>
    </form>
  </div>

  <script>
    // ===== KONFIG =====
    const GAS_URL = 'PASTE_WEB_APP_URL_DI_SINI';      // <— ganti dgn URL Web App GAS
    const API_KEY = 'PASTE_WEBAPP_API_KEY_DI_SINI';   // <— sama dgn WEBAPP_API_KEY (Script Properties)

    const FIELDS = [
      'Container','Date','Shipment Code','DPF No','Consignee','Pickup',
      'Transporter','Container No','Seal No','Plate No','Driver','Loader'
    ];

    // ===== Helper UI =====
    const $ = id => document.getElementById(id);
    const statusEl = $('status');
    function setStatus(msg, ok=false) {
      statusEl.textContent = msg;
      statusEl.className = 'status ' + (ok ? 'ok' : 'err');
    }

    // Auto-UPPERCASE sambil menjaga caret
    FIELDS.forEach(id => {
      const el = $(id);
      el && el.addEventListener('input', () => {
        const s = el.selectionStart, e = el.selectionEnd;
        el.value = el.value.toUpperCase();
        el.setSelectionRange(s, e);
      });
    });

    // Reset
    $('btnReset').addEventListener('click', () => {
      FIELDS.forEach(id => { const el = $(id); if (el) el.value = ''; });
      setStatus('');
    });

    // Telegram WebApp integration (opsional)
    const tg = window.Telegram ? window.Telegram.WebApp : null;
    if (tg) {
      tg.expand();
      tg.MainButton.setText('KIRIM DATA');
      tg.MainButton.onClick(() => $('btnSubmit').click());
    }

    // Validasi Container No (4 huruf + 7 angka)
    const validContainerNo = s => /^[A-Z]{4}\d{7}$/.test(String(s || '').trim());

    const collectData = () => {
      const obj = {};
      FIELDS.forEach(id => { obj[id] = ($(id)?.value || '').toUpperCase().trim(); });
      return obj;
    };

    $('f').addEventListener('submit', async (ev) => {
      ev.preventDefault();
      setStatus('');

      const data = collectData();
      if (!data['Container'] || !data['Date'] || !data['Driver'] || !data['Container No']) {
        return setStatus('Harap isi field wajib (Container, Date, Driver, Container No).');
      }
      if (!validContainerNo(data['Container No'])) {
        return setStatus('Container No tidak valid (4 huruf + 7 angka). Contoh: ABCD1234567');
      }

      try {
        const u = tg?.initDataUnsafe?.user || null;
        const payload = {
          source: 'webapp',
          api_key: API_KEY,
          data,
          user_first_name: u ? (u.first_name || '') : '',
          user_last_name:  u ? (u.last_name || '') : ''
        };

        const res = await fetch(GAS_URL, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload)
        });
        const json = await res.json();

        if (json.ok) {
          setStatus(json.msg || 'Data tersimpan.', true);
          try { tg?.HapticFeedback?.impactOccurred('light'); } catch {}
          // Optional: tutup otomatis di Telegram
          setTimeout(() => tg?.close(), 700);
          // Optional: bersihkan form
          // $('btnReset').click();
        } else {
          setStatus(json.error || 'Gagal menyimpan.');
        }
      } catch (e) {
        setStatus('Error jaringan: ' + e.message);
      }
    });
  </script>
</body>
</html>
