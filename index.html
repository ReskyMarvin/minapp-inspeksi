<!doctype html>
<html lang="id">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Pallet Scanner — C1</title>
  <style>
    body{font-family:system-ui,Segoe UI,Roboto,Arial,sans-serif;margin:0;padding:16px;background:#f7f7f7}
    .wrap{max-width:520px;margin:auto}
    h2{margin:0 0 12px}
    video,canvas{width:100%;border-radius:12px;background:#000}
    .row{display:flex;gap:8px;align-items:center;margin:12px 0}
    button{flex:1;padding:12px;border-radius:10px;border:0;cursor:pointer;font-weight:600}
    #startBtn{background:#0ea5e9;color:#fff}
    #stopBtn{background:#e5e7eb}
    #okBtn{background:#22c55e;color:#fff}
    #result{padding:12px;border-radius:10px;background:#fff;word-break:break-word;min-height:48px}
    .hint{color:#6b7280;font-size:12px}
    .ok{color:#16a34a;font-weight:600}
    .err{color:#b91c1c;font-weight:600}
    .badge{display:inline-block;padding:2px 8px;border-radius:999px;font-size:12px;font-weight:600}
    .badge-ok{background:#dcfce7;color:#166534}
    .badge-bad{background:#fee2e2;color:#991b1b}
    .muted{color:#6b7280}
  </style>
</head>
<body>
<div class="wrap">
  <h2>Pallet Scanner — C1</h2>

  <div class="row">
    <button id="startBtn">Start Camera</button>
    <button id="stopBtn" disabled>Stop</button>
  </div>

  <video id="video" playsinline></video>
  <canvas id="canvas" style="display:none;"></canvas>

  <h3>Hasil</h3>
  <div id="result">Belum ada hasil.</div>

  <div class="row">
    <button id="okBtn" disabled>OK</button>
  </div>

  <p class="hint">Format QR yang didukung: <code>BATCH=...;PALLET=...;QTY=...</code> (case-insensitive). Validasi ke <b>CHECKLIST_C1</b>.</p>
  <p class="muted" id="statusText"></p>
</div>

<script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.js"></script>
<script>
(() => {
  const WEB_APP_URL = 'https://script.google.com/macros/s/AKfycbwXeYhelczmcjC9cDKSJU_hbD_zrDn59PbS50U9RfdHFeTnvr6XZRleuSPem8zB_MH3/exec'; // << GANTI
  const CONTAINER   = 'C1';

  const video = document.getElementById('video');
  const canvas = document.getElementById('canvas');
  const result = document.getElementById('result');
  const startBtn = document.getElementById('startBtn');
  const stopBtn  = document.getElementById('stopBtn');
  const okBtn    = document.getElementById('okBtn');
  const statusText = document.getElementById('statusText');

  let stream = null;
  let rafId = null;
  let lastQR = '';
  let lastState = null; // {ok, valid, reason?, batch, pallet, qty}
  const sessionSeen = new Set();

  // Bunyi
  function beepOK(){ tone(1200, 0.12, 0.15); }
  function beepBad(){ tone(400,  0.18, 0.25); }
  function tone(freq, vol=0.1, dur=0.2){
    try{
      const ctx = new (window.AudioContext || window.webkitAudioContext)();
      const osc = ctx.createOscillator();
      const gain= ctx.createGain();
      osc.type="sine"; osc.frequency.value=freq; gain.gain.value=vol;
      osc.connect(gain); gain.connect(ctx.destination);
      osc.start(); osc.stop(ctx.currentTime + dur);
    }catch(e){}
  }

  async function startCamera() {
    try {
      stream = await navigator.mediaDevices.getUserMedia({
        video: { facingMode: { ideal: 'environment' } },
        audio: false
      });
      video.srcObject = stream;
      await video.play();
      startBtn.disabled = true;
      stopBtn.disabled = false;
      statusText.textContent = 'Kamera aktif. Arahkan QR ke kamera.';
      scanLoop();
    } catch (err) {
      console.error(err);
      result.innerHTML = '<span class="err">Gagal akses kamera: ' + (err.message || err) + '</span>';
    }
  }

  function stopCamera() {
    if (rafId) cancelAnimationFrame(rafId);
    if (stream) { stream.getTracks().forEach(t => t.stop()); stream = null; }
    video.pause(); video.srcObject = null;
    startBtn.disabled = false; stopBtn.disabled = true;
    statusText.textContent = '';
  }

  function parseKv(raw){
    const o = { batch:'', pallet:'', qty:'' };
    if (raw.indexOf('=') === -1) return o;
    raw.split(';').forEach(part=>{
      const i = part.indexOf('=');
      if (i === -1) return;
      const k = part.slice(0,i).trim().toUpperCase();
      const v = part.slice(i+1).trim();
      if (k === 'BATCH') o.batch = v;
      else if (k === 'PALLET') o.pallet = v;
      else if (k === 'QTY') o.qty = v;
    });
    return o;
  }

  function renderResult(qr, state){
    const kv = parseKv(qr);
    // fallback kecil untuk format "BATCH-PALLET"
    if (!kv.batch || !kv.pallet) {
      const j = qr.indexOf('-');
      if (j > 0) {
        kv.batch = kv.batch || qr.slice(0, j).trim();
        kv.pallet = kv.pallet || qr.slice(j + 1).trim();
      }
    }
    let badge = '';
    if (state?.valid) {
      badge = `<div class="badge badge-ok">VALID (tersimpan)</div>`;
    } else {
      let reason = state?.reason || 'INVALID';
      if (reason === 'NOT_LISTED') reason = 'Tidak terdaftar (BATCH+PALLET)';
      if (reason === 'DUPLICATE') reason = 'Duplikat (sudah USED)';
      if (reason === 'FORMAT') reason = 'Format salah: butuh BATCH & PALLET';
      badge = `<div class="badge badge-bad">${reason}</div>`;
    }
    result.innerHTML = `
      <div>${qr}</div>
      <div class="muted">
        Batch: <b>${kv.batch || '-'}</b> • Pallet: <b>${kv.pallet || '-'}</b> • Qty: <b>${kv.qty || '-'}</b>
      </div>
      ${badge}
    `;
  }

  function updateUIForState(state){
    if (!state) { okBtn.disabled = true; return; }
    if (state.valid) {
      okBtn.disabled = sessionSeen.has(lastQR);
      statusText.innerHTML = '<span class="ok">✅ Valid & tersimpan.</span>';
    } else {
      okBtn.disabled = true;
      const msg =
        state.reason === 'DUPLICATE' ? '⚠️ Sudah discan (USED).'
        : state.reason === 'NOT_LISTED' ? '❌ Tidak ada di checking list.'
        : state.reason === 'FORMAT' ? '⚠️ Format harus BATCH & PALLET.'
        : '❌ Tidak valid.';
      statusText.innerHTML = `<span class="err">${msg}</span>`;
    }
  }

  async function validateServer(qr) {
    try {
      const resp = await fetch(WEB_APP_URL, {
        method:'POST',
        headers:{ 'Content-Type':'application/json' },
        body: JSON.stringify({ qr, container: CONTAINER })
      });
      return await resp.json(); // {ok, valid, reason?, batch, pallet, qty}
    } catch (e) {
      return { ok:false, error:String(e) };
    }
  }

  async function scanLoop() {
    const w = video.videoWidth, h = video.videoHeight;
    if (!w || !h) { rafId = requestAnimationFrame(scanLoop); return; }

    canvas.width = w; canvas.height = h;
    const ctx = canvas.getContext('2d');
    ctx.drawImage(video, 0, 0, w, h);
    const img = ctx.getImageData(0, 0, w, h);

    const code = jsQR(img.data, img.width, img.height, { inversionAttempts:'dontInvert' });
    if (code && code.data) {
      const isNew = code.data !== lastQR;
      if (isNew) {
        const res = await validateServer(code.data);
        if (!res.ok) {
          lastQR = ''; lastState = null;
          statusText.innerHTML = '<span class="err">Gagal validasi ke server.</span>';
          beepBad();
        } else {
          lastQR = code.data;
          lastState = res;
          renderResult(lastQR, lastState);
          updateUIForState(lastState);
          res.valid ? beepOK() : beepBad();
        }
      }
    }
    rafId = requestAnimationFrame(scanLoop);
  }

  okBtn.addEventListener('click', () => {
    if (!lastQR || !lastState?.valid) return;
    sessionSeen.add(lastQR);
    okBtn.disabled = true;
    statusText.innerHTML = '<span class="ok">✔️ Ditandai selesai.</span>';
  });

  startBtn.addEventListener('click', startCamera);
  stopBtn.addEventListener('click', stopCamera);
  window.addEventListener('pagehide', stopCamera);
})();
</script>
</body>
</html>
