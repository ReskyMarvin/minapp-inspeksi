<!doctype html>
<html lang="id">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>QR Outbound Scanner (Simple)</title>
  <style>
    body{margin:0;font-family:system-ui,Arial,sans-serif;background:#0b0c10;color:#e5e7eb}
    header{padding:12px 16px;font-weight:600}
    #wrap{padding:12px 16px;display:grid;gap:10px}
    #view{position:relative;max-width:640px;width:100%;aspect-ratio:4/3;border:1px solid #1f2937;border-radius:12px;overflow:hidden}
    #video{width:100%;height:100%;object-fit:cover;display:block}
    #status{font-size:14px;opacity:.9}
    .ok{color:#22c55e}.err{color:#f43f5e}.muted{color:#9ca3af}
    #log{font-size:13px;max-height:140px;overflow:auto;border:1px solid #1f2937;border-radius:10px;padding:8px}
  </style>
</head>
<body>
  <header>QR Outbound Scanner</header>
  <div id="wrap">
    <div id="view"><video id="video" playsinline muted></video></div>
    <div id="status" class="muted">Meminta izin kamera…</div>
    <div id="log"></div>
  </div>

  <!-- jsQR CDN -->
  <script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.js"></script>
  <script>
    // ===== KONFIG =====
    const ENDPOINT_URL = 'https://script.google.com/macros/s/AKfycbwXeYhelczmcjC9cDKSJU_hbD_zrDn59PbS50U9RfdHFeTnvr6XZRleuSPem8zB_MH3/exec'; // <— GANTI
    const SCAN_MS = 120;         // interval frame
    const DEDUP_MS = 15000;      // cegah kirim duplikat <= 15s

    // ===== ELEMEN =====
    const video = document.getElementById('video');
    const statusEl = document.getElementById('status');
    const logEl = document.getElementById('log');

    // kanvas offscreen untuk baca frame
    const canvas = document.createElement('canvas');
    const ctx = canvas.getContext('2d', { willReadFrequently: true });

    // dedup sederhana
    const last = new Map(); // qr -> ts

    function setStatus(msg, cls='muted'){ statusEl.className = cls; statusEl.textContent = msg; }
    function addLog(text){ const d=document.createElement('div'); d.textContent=text; logEl.prepend(d); }

    async function postQR(qr){
      try{
        const r = await fetch(ENDPOINT_URL, {
          method:'POST',
          headers:{'Content-Type':'application/json'},
          body: JSON.stringify({ qr })
        });
        const j = await r.json().catch(()=>({}));
        if(j.ok){ setStatus(`Terkirim: ${qr}`, 'ok'); addLog(`✅ ${new Date().toLocaleTimeString()} - ${qr}`); }
        else{ setStatus(`Gagal: ${j.error||'unknown'}`, 'err'); addLog(`❌ ${qr} → ${j.error||'unknown'}`); }
      }catch(e){
        setStatus(`Error jaringan: ${e.message}`, 'err'); addLog(`⚠️  NetErr - ${qr} → ${e.message}`);
      }
    }

    function shouldSkip(qr){
      const now = Date.now();
      // bersihkan entri lama
      for(const [k,t] of last) if(now - t > DEDUP_MS) last.delete(k);
      if(last.has(qr)) return true;
      last.set(qr, now);
      return false;
    }

    async function start(){
      try{
        setStatus('Membuka kamera belakang…');
        const stream = await navigator.mediaDevices.getUserMedia({
          video: { facingMode: { exact: 'environment' } }, // langsung kamera belakang
          audio: false
        });
        video.srcObject = stream;
        await video.play();
        setStatus('Memindai… arahkan ke QR', 'muted');

        // loop scan
        const loop = () => {
          const w = video.videoWidth, h = video.videoHeight;
          if(w && h){
            if(canvas.width!==w){ canvas.width=w; canvas.height=h; }
            ctx.drawImage(video, 0, 0, w, h);
            const img = ctx.getImageData(0, 0, w, h);
            const code = jsQR(img.data, w, h, { inversionAttempts: 'attemptBoth' });
            const qr = code && code.data ? String(code.data).trim() : '';
            if(qr && !shouldSkip(qr)){ postQR(qr); }
          }
          setTimeout(loop, SCAN_MS);
        };
        loop();
      }catch(e){
        // fallback: jika exact gagal (beberapa device), coba ideal environment
        if(e.name === 'OverconstrainedError' || e.name === 'NotFoundError'){
          try{
            const stream = await navigator.mediaDevices.getUserMedia({
              video: { facingMode: { ideal: 'environment' } },
              audio:false
            });
            video.srcObject = stream;
            await video.play();
            setStatus('Memindai… (fallback kamera belakang)', 'muted');
            const loop = () => {
              const w = video.videoWidth, h = video.videoHeight;
              if(w && h){
                if(canvas.width!==w){ canvas.width=w; canvas.height=h; }
                ctx.drawImage(video, 0, 0, w, h);
                const img = ctx.getImageData(0, 0, w, h);
                const code = jsQR(img.data, w, h, { inversionAttempts: 'attemptBoth' });
                const qr = code && code.data ? String(code.data).trim() : '';
                if(qr && !shouldSkip(qr)){ postQR(qr); }
              }
              setTimeout(loop, SCAN_MS);
            };
            loop();
            return;
          }catch(e2){
            setStatus('Tidak bisa akses kamera belakang. Izin kamera atau perangkat bermasalah.', 'err');
            addLog(`⚠️ ${e2.name||'Err'} - ${e2.message||e2}`);
            return;
          }
        }else{
          setStatus('Gagal mengakses kamera. Cek izin browser.', 'err');
          addLog(`⚠️ ${e.name||'Err'} - ${e.message||e}`);
        }
      }
    }

    // mulai otomatis
    if(!('mediaDevices' in navigator)){ setStatus('Browser tidak mendukung kamera.', 'err'); }
    else { start(); }
  </script>
</body>
</html>
